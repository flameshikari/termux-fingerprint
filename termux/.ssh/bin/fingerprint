#!/data/data/com.termux/files/usr/bin/bash

ACTIVITY=pw.hexed.fingerprint/.MainActivity
ADDRESS=127.0.0.1
PORT=10451

[[ -n "$SSH_CLIENT" ]] || [[ -n "$SSH_TTY" ]] && exit 1

eval $(termux-keystore list | jq '(. | length) == 0') && exit 1

am start -n "$ACTIVITY" &> /dev/null &

while true; do
    OUTPUT=$(nc -dl "$ADDRESS" "$PORT")
    RESULT=$(echo "$OUTPUT" | jq -r '.auth_result // empty' 2> /dev/null)
    if [[ "$RESULT" ]]; then
        echo "$OUTPUT" | jq -M
        [[ "$RESULT" == 'AUTH_RESULT_SUCCESS' ]] && exit 0 || exit 1
     fi
done
